const translations = {
    ar: {
        nav_home: "الرئيسية",
        nav_problem: "المشكلة",
        nav_features: "المميزات",
        nav_content: "محتوى الكورس",
        nav_how_it_works: "كيف يعمل",
        nav_pricing: "الأسعار",
        nav_faq: "الأسئلة الشائعة",
        nav_cta: "ابدأ أسبوعك المجاني",
        hero_title: `استعد لزمالة الطب النفسي…<br>وأنت في بريكات الشيفت`,
        hero_subtitle: `فيديوهات مبسطة ومركزة + <strong>بنك أسئلة</strong> يحاكي الامتحان<br>+ خطة مذاكرة يومية قصيرة.<br>علشان تذاكر بثقة… من غير توهّان في التيكست بوك.`,
        hero_points_1: "20–30 دقيقة يوميًا معدل مذاكرة مفيد وخفيف",
        hero_points_2: "حل منتظم بدل ما تتوه بين ورق الأسئلة",
        hero_points_3: "متابعة تقدمك عشان تعرف أنت ضعيف فى ايه",
        hero_button: "ابدأ أسبوعك المجاني الآن",
        hero_note: "بدون بطاقة ائتمان",
        stat_students: "بيذاكر من خلال التطبيق",
        stat_students_count: "30 الف متعلم طبي",
        stat_hours: "اكتر من مليون ساعة مشاهدة",
        stat_hours_desc: "لمحتوى تعليم طبي فى 2025",
        stat_content: "اكتر من 180 الف سؤال",
        stat_content_desc: "فى بنوك اسئلة طبية",
        intro_text: "معظم طرق التحضير معمولة لناس متفرغة.. لكن إنت طبيب شغال، مسؤول، ووقتك مسروق.<br>طبيعي تحس إنك تايه لو بتذاكر بنفس الأدوات الغلط.",

        // Problem Section
        pain_title: "هل ده شبهك؟",
        pain_1: "لو بتفتح التيكست بوك وبتقف قدامه مستتقله",
        pain_2: "لو الشغل مخليك تحس إن مفيش وقت تذاكر للامتحان",
        pain_3: "لو مش عارف تبدأ منين علشان تعدى الامتحان",

        // Value Proposition
        value_title: "في Psychiatry Notes بيحوّل مذاكرة الزمالة من “مجهود عشوائي” إلى <strong>نظام يومي واضح</strong>:",
        value_desc: "تتفرج صح، تحل صح … تعدي الامتحان .",

        // What You Get
        wyg_title: "جوا التطبيق هتلاقي:",
        wyg_video_title: "شروحات فيديو",
        wyg_video_desc: "شرح مركز مبسط للكتاب<br>رسومات توضيحية تسهل المذاكرة<br>شرح الفيديو بشكل نقاشي بين شخصين<br>خلاصة اي موضوع فى ربع ساعة",
        wyg_book_title: "كتاب متكامل",
        wyg_book_desc: "كتاب مصمم على منهج الزمالة المصرية بالزبط<br>مدمج بالكتاب المعلومات الزايده فى بنوك الاسئلة<br>الكتاب الكترونى علشان تقدر تذاكر من اي حته<br>تقدر تطلب النسخه الورقيه وتوصلك لحد البيت",
        wyg_qbank_title: "بنك اسئلة",
        wyg_qbank_desc: "اهم بنوك الاسئلة اللى بتيجي منها الامتحان<br>الاسئلة محلولة بتفسير الاجابة الصح والغلط<br>محاكاة للامتحان بشكل كامل وواقعى<br>مراجعة ذكية للاسئلة اللى حافظها او غلطت فيها<br>تقدر تذاكر بالموضوع وبالشابتر بحيث تدرب واحده واحده",

        // Comparison (The Shift)
        comp_title: "مقارنة سريعة",
        comp_old_title: "الطريقة القديمة",
        comp_old_points: "بتبدأ بشكل عشوائي -> <strong>توهان</strong><br>مذاكرة كتير بس مش المطلوب -> <strong>وقت بيضيع</strong><br>بحل كتير وبعدين بنسى -> <strong>نفس الغلط بيتكرر</strong>",
        comp_new_title: "مع Psychiatry Notes",
        comp_new_points: "كل يوم موضوع جديد<br>تتفرج على فيديو وبعدين تذاكر من الكتاب وبعدين تحل الاسئلة<br>هتعدى الامتحان وانت مرتاح",

        // How It Works
        hiw_title: "ازاي هتستخدمه؟... في 3 خطوات:",
        hiw_step_1: "1. <strong>حمّل التطبيق</strong> وسجّل حسابك",
        hiw_step_2: "2. اختار <strong>هدفك وموعد الامتحان</strong>",
        hiw_step_3: "3. امشي على الخطة:<br><strong>اتفرج على فيديو - ذاكر من كتاب - حل بنك أسئلة</strong>",
        hiw_cta: "ابدأ مجانًا الآن",

        // Pricing
        price_free_title: "ابدأ مجانًا",
        price_free_desc: "<strong>أول أسبوع مجاني</strong> علشان تجرّب وتشوف هل النظام مناسب لك ولا لأ.",
        price_subtitle: "بعد الأسبوع المجاني (اختار باقتك):",
        price_monthly: "150 جنيه / شهر",
        price_yearly: "1200 جنيه / سنة",
        // Plan Badges/Details
        plan_monthly_label: "شهري",
        plan_yearly_label: "سنوي (الأوفر)",
        save_amount_badge: "وفر 600 جنيه!",
        yearly_breakdown: "يعني الشهر واقف بـ 100 جنيه بس",
        price_reassurance: "<strong>إلغاء في أي وقت</strong><br><strong>الدفع آمن</strong><br><strong>الدعم بيرد عليك</strong> داخل التطبيق/واتساب/تيليجرام",

        // FAQ
        faq_title: "الأسئلة الشائعة",
        faq_1_q: "هل التطبيق مجاني؟",
        faq_1_a: "نعم، الأسبوع الأول مجاني بالكامل بدون الحاجة لبطاقة ائتمان. بعد ذلك يمكنك الاشتراك (150 جنيه/شهر أو 1200 جنيه/سنة) للاستمرار. يمكنك الإلغاء في أي وقت.",
        faq_2_q: "هل الأسئلة مطابقة لنظام الامتحان الحقيقي؟",
        faq_2_a: "نعم، بنك الأسئلة مصمم ليحاكي نظام الامتحان الحقيقي (100 سؤال / 150 دقيقة).",
        faq_3_q: "كم عدد الأسئلة المتوفرة؟",
        faq_3_a: "لدينا أكثر من 11,000 سؤال مع شروحات تفصيلية ويتم تحديثها بشكل مستمر.",
        faq_5_q: "كيف يمكنني التواصل مع الدعم؟",
        faq_5_a: "يمكنك التواصل معنا عبر WhatsApp أو Telegram الموجودين في الصفحة.",
        // New FAQs
        faq_new_1_q: "هل المحتوى بديل عن التيكست بوك؟",
        faq_new_1_a: "هو <strong>مش بديل حرفيًا</strong>… لكنه بيطلعلك <strong>الـ High-Yield</strong> اللي يخدم الامتحان، ويخليك تذاكر بذكاء.",
        faq_new_2_q: "مستوى الأسئلة عامل إزاي؟",
        faq_new_2_a: "الـ QBank معمول علشان يقرّبك من <strong>نمط الامتحان</strong>: Topic-wise + Timed + مراجعة أخطاء.",
        faq_new_3_q: "هعرف أتتبع تقدمي؟",
        faq_new_3_a: "أيوة — هتشوف <strong>نسب إنجاز</strong> + <strong>نقاط ضعف</strong> + توصيات مراجعة.",

        // Legacy / Shared
        final_title: "لو كملت للآخر… غالبًا ده ليك",
        for_you: "الكورس ده ليك لو:",
        chk_1: "عايز مصدر واحد موثوق",
        chk_2: "عايز خطة تمشي عليها",
        chk_3: "عايز تدخل الامتحان وإنت فاهم",
        final_btn: "ابدأ أسبوعك المجاني الآن",
        final_note: "بدون فيزا - بدون مخاطرة",
        trust_text: `<span style="color: var(--primary-yellow);">★</span> يثق بنا أكثر من <strong>2000 طبيب</strong>`,
        store_ios: "TestFlight (iOS)",
        store_xiaomi: "Xiaomi Store",
        store_apk: "Direct APK",
        copyright: "&copy; 2025 Bardi. جميع الحقوق محفوظة.",
        label_huawei: "لهواتف هواوي",
        label_xiaomi: "لهواتف شاومي",
        label_ios: "لهواتف آيفون",
        nav_download: "حمل التطبيق",
        floating_cta: "ابدأ مجاناً وحمل التطبيق",
        btn_huawei: "حمل من AppGallery",
        btn_xiaomi: "Xiaomi Store",
        btn_ios: "TestFlight",
        dl_card_free: "مجـــــــانا اول اسبوع",
        dl_card_title: "حمل التطبيق وابدا الان",
        popup_title: "إعداد TestFlight",
        popup_step1: "أولاً: قم بتحميل تطبيق TestFlight من متجر أبل",
        popup_step1_btn: "تحميل TestFlight",
        popup_step2: "لديك TestFlight بالفعل أو قمت بتحميله؟",
        popup_step2_btn: "نزل التطبيق من هنا",
        plan_monthly_label: "شهري",
        plan_3months_label: "3 شهور",
        plan_6months_label: "6 شهور",
        plan_save_label: "وفر أكثر",
        plan_per_month: "/ شهر",
        plan_per_year: "/ سنة",
        currency_egp: "جنيه",
        label_apk: "تحميل مباشر",
        btn_apk: "تحميل APK",
        apk_download_msg: "جاري بدء التحميل... يرجى مراجعة قائمة التنزيلات في هاتفك أو شريط الإشعارات."
    },
    en: {
        nav_home: "Home",
        nav_problem: "The Problem",
        nav_features: "Features",
        nav_content: "Course Content",
        nav_how_it_works: "How it Works",
        nav_pricing: "Pricing",
        nav_faq: "FAQ",
        nav_cta: "Start Free Week",
        hero_title: `Prepare for Psychiatry Fellowship<br>While on Break Shifts`,
        hero_subtitle: `Simplified videos + <strong>Real-exam QBank</strong> + Short daily study plan.<br>Study with confidence... without getting lost in textbooks.`,
        hero_points_1: "20–30 daily minutes, useful and light study rate",
        hero_points_2: "Regular practice instead of getting lost in question papers",
        hero_points_3: "Track your progress to know your weak points",
        hero_button: "Start Your Free Week Now",
        hero_note: "No Credit Card Required",
        stat_students: "Studying via App",
        stat_students_count: "30k Medical Learners",
        stat_hours: "Over 1 Million Views",
        stat_hours_desc: "For medical content in 2025",
        stat_content: "Over 180k Questions",
        stat_content_desc: "In medical question banks",
        intro_text: "Most prep methods are for people who are free... But you are a working doctor.<br>It's normal to feel lost using the wrong tools.",

        // Problem Section
        pain_title: "Does this sound like you?",
        pain_1: "Opening the textbook and feeling paralyzed?",
        pain_2: "Work makes you feel there's no time to study?",
        pain_3: "Don't know where to start to pass?",

        // Value Proposition
        value_title: "Psychiatry Notes turns Fellowship study from \"Random Effort\" to a <strong>Clear Daily System</strong>:",
        value_desc: "Watch right, solve right... Pass the exam.",

        // What You Get
        wyg_title: "What's inside the App:",
        wyg_video_title: "Video Explanations",
        wyg_video_desc: "Condensed simplified book explanation<br>Illustrations to ease studying<br>Discussion-style video format<br>Summary of any topic in 15 mins",
        wyg_book_title: "The Book",
        wyg_book_desc: "Designed exactly for the Egyptian Fellowship curriculum<br>Integrated with extra QBank info<br>Digital book to study from anywhere<br>Order hard copy delivered to your door",
        wyg_qbank_title: "Question Bank",
        wyg_qbank_desc: "Top banks where exams come from<br>Solved with explanations for right and wrong answers<br>Full and realistic exam simulation<br>Smart review for memorized or wrong questions<br>Study by topic and chapter to practice step-by-step",

        // Comparison (The Shift)
        comp_title: "Quick Comparison",
        comp_old_title: "The Old Way",
        comp_old_points: "Start randomly -> <strong>Lost</strong><br>Study a lot but not what's needed -> <strong>Wasted Time</strong><br>Solve a lot then forget -> <strong>Same Mistakes Repeated</strong>",
        comp_new_title: "With Psychiatry Notes",
        comp_new_points: "New topic every day<br>Watch video, study book, then solve questions<br>Pass the exam comfortably",

        // How It Works
        hiw_title: "How to use it?... In 3 steps:",
        hiw_step_1: "1. <strong>Download App</strong> and Register",
        hiw_step_2: "2. Choose <strong>Goal and Exam Date</strong>",
        hiw_step_3: "3. Follow the plan:<br><strong>Watch Video - Study Book - Solve QBank</strong>",
        hiw_cta: "Start Free Now",

        // Pricing
        price_free_title: "Start Free",
        price_free_desc: "<strong>First week free</strong> to try and see if the system fits you.",
        price_subtitle: "After Free Week (Choose Plan):",
        price_monthly: "150 EGP / Month",
        price_yearly: "1200 EGP / Year",
        // Plan Badges/Details
        plan_monthly_label: "Monthly",
        plan_yearly_label: "Yearly (Best Value)",
        save_amount_badge: "Save 600 EGP!",
        yearly_breakdown: "Equivalent to 100 EGP/Month",
        price_reassurance: "<strong>Cancel Anytime</strong><br><strong>Secure Payment</strong><br><strong>Support Responds</strong> in App/WhatsApp/Telegram",

        // FAQ
        faq_title: "Frequently Asked Questions",
        faq_1_q: "Is the app free?",
        faq_1_a: "Yes, the first week is completely free with no credit card required. After that, you can subscribe (150 EGP/Month or 1200 EGP/Year). Cancel anytime.",
        faq_2_q: "Do the questions match the real exam system?",
        faq_2_a: "Yes, the QBank is designed to simulate the real exam environment (100 questions / 150 minutes).",
        faq_3_q: "How many questions are available?",
        faq_3_a: "We have over 11,000 questions with detailed explanations, updated continuously.",
        faq_5_q: "How can I contact support?",
        faq_5_a: "You can reach us via WhatsApp or Telegram links on the page.",
        // New FAQs
        faq_new_1_q: "Is content a replacement for textbooks?",
        faq_new_1_a: "It's <strong>not a literal replacement</strong>... but it extracts <strong>High-Yield</strong> material for the exam, letting you study smartly.",
        faq_new_2_q: "What is the question level?",
        faq_new_2_a: "The QBank is made to get you close to <strong>Exam Pattern</strong>: Topic-wise + Timed + Error Review.",
        faq_new_3_q: "Can I track my progress?",
        faq_new_3_a: "Yes — You will see <strong>completion rates</strong> + <strong>weak points</strong> + review recommendations.",

        // Legacy / Shared
        final_title: "If you read this far... This is likely for you",
        for_you: "This course is for you if:",
        chk_1: "You want one trusted source",
        chk_2: "You want a plan to follow",
        chk_3: "You want to enter the exam understanding",
        final_btn: "Start Your Free Week Now",
        final_note: "No Visa - No Risk",
        trust_text: `<span style="color: var(--primary-yellow);">★</span> Trusted by over <strong>2000 doctors</strong>`,
        store_ios: "TestFlight (iOS)",
        store_xiaomi: "Xiaomi Store",
        store_apk: "Direct APK",
        copyright: "&copy; 2025 Bardi. All rights reserved.",
        label_huawei: "For Huawei",
        label_xiaomi: "For Xiaomi",
        label_ios: "For iPhone",
        nav_download: "Download App",
        floating_cta: "Start Free & Download",
        btn_huawei: "Get on AppGallery",
        btn_xiaomi: "Xiaomi Store",
        btn_ios: "TestFlight",
        dl_card_free: "FREE FIRST WEEK",
        dl_card_title: "Download the App & Start Now",
        popup_title: "TestFlight Setup",
        popup_step1: "Step 1: Download TestFlight from App Store",
        popup_step1_btn: "Download TestFlight",
        popup_step2: "Already have TestFlight?",
        popup_step2_btn: "Tap here to Install App",
        plan_monthly_label: "Monthly",
        plan_3months_label: "3 Months",
        plan_6months_label: "6 Months",
        plan_save_label: "Best Value",
        plan_per_month: "/ Mo",
        plan_per_year: "/ Yr",
        currency_egp: "EGP",
        label_apk: "Direct Download",
        btn_apk: "Download APK",
        apk_download_msg: "Download started... Please check your Downloads list or Notification bar."
    }
};

const langToggleBtn = document.getElementById('lang-toggle');
const htmlEl = document.documentElement;

langToggleBtn.addEventListener('click', () => {
    const currentLang = htmlEl.getAttribute('lang');
    const newLang = currentLang === 'ar' ? 'en' : 'ar';
    const newDir = newLang === 'ar' ? 'rtl' : 'ltr';

    htmlEl.setAttribute('lang', newLang);
    htmlEl.setAttribute('dir', newDir);
    langToggleBtn.textContent = newLang === 'ar' ? 'English' : 'العربية';

    // Save preference
    localStorage.setItem('preferred_lang', newLang);

    updateContent(newLang);
});

// Mobile Menu Toggle
const menuToggle = document.getElementById('mobile-menu');
const navMenuWrapper = document.querySelector('.nav-menu-wrapper');

menuToggle.addEventListener('click', () => {
    menuToggle.classList.toggle('active');
    navMenuWrapper.classList.toggle('active');
});

// Close menu when clicking a link
document.querySelectorAll('.nav-menu a').forEach(link => {
    link.addEventListener('click', () => {
        menuToggle.classList.remove('active');
        navMenuWrapper.classList.remove('active');
    });
});

function updateContent(lang) {
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            el.innerHTML = translations[lang][key];
        }
    });
}

// Navbar Scroll Effect
window.addEventListener('scroll', () => {
    const navbar = document.querySelector('.navbar');
    if (window.scrollY > 50) {
        navbar.style.background = 'rgba(17, 17, 24, 0.98)';
        navbar.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
    } else {
        navbar.style.background = 'rgba(17, 17, 24, 0.9)';
        navbar.style.boxShadow = 'none';
    }
});

// Animations on Scroll
const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
};

const scrollObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('fade-in-up');
            entry.target.style.opacity = 1;

            // Trigger shine effect for phone frames
            if (entry.target.classList.contains('phone-frame')) {
                entry.target.classList.add('shine-active');
            }

            scrollObserver.unobserve(entry.target);
        }
    });
}, observerOptions);

// Floating CTA Visibility Logic
const floatingCta = document.getElementById('floating-cta');
const heroSection = document.getElementById('home');

const floatingObserverOptions = {
    root: null,
    threshold: 0.5
};

const floatingObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            if (floatingCta) floatingCta.classList.remove('visible');
        } else {
            if (floatingCta) floatingCta.classList.add('visible');
        }
    });
}, floatingObserverOptions);

// Analytics Tracking Config
const TRACKING_CONFIG = {
    huawei: { selector: '.btn-huawei', name: 'Huawei AppGallery' },
    xiaomi: { selector: '.btn-xiaomi', name: 'Xiaomi Store' },
    testflight_dl: { id: 'btn-testflight-download', name: 'Download TestFlight', event: 'ViewContent' },
    app_install: { id: 'btn-app-install', name: 'Install Bardi App', event: 'CompleteRegistration' }
};

// Global Stats Counter Animation Function
const startCount = (el) => {
    const target = +el.getAttribute('data-target');
    const suffix = el.getAttribute('data-suffix') || '';
    const duration = 2000;
    const increment = target / (duration / 16);

    let current = 0;
    const updateCount = () => {
        current += increment;
        if (current < target) {
            el.textContent = Math.ceil(current).toLocaleString() + suffix;
            requestAnimationFrame(updateCount);
        } else {
            el.textContent = target.toLocaleString() + suffix;
        }
    };
    updateCount();
};

// Initialize Everything on DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
    // 1. Language Persistence
    // 1. Language Persistence & Initial Content Load
    const savedLang = localStorage.getItem('preferred_lang') || 'ar';

    // Set attributes for consistency
    htmlEl.setAttribute('lang', savedLang);
    htmlEl.setAttribute('dir', savedLang === 'ar' ? 'rtl' : 'ltr');
    langToggleBtn.textContent = savedLang === 'ar' ? 'English' : 'العربية';

    // ALWAYS update content on load to fill empty data-i18n elements
    updateContent(savedLang);

    // 2. Scroll Animations
    document.querySelectorAll('.card, .feature-card, .shift-item, .phone-frame, .wyg-item, .hero-content').forEach(el => {
        el.classList.add('fade-in-up');
        el.style.opacity = 0;
        scrollObserver.observe(el);
    });

    // 3. Floating CTA
    if (heroSection && floatingCta) {
        floatingObserver.observe(heroSection);
    }

    // 4. TestFlight Popup
    const popup = document.getElementById('ios-popup');
    const iosBtns = document.querySelectorAll('.btn-ios');
    const closeBtn = document.querySelector('.popup-close');

    if (popup && iosBtns.length > 0) {
        iosBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                popup.classList.add('active');
            });
        });
        if (closeBtn) {
            closeBtn.addEventListener('click', () => popup.classList.remove('active'));
        }
        popup.addEventListener('click', (e) => { if (e.target === popup) popup.classList.remove('active'); });
    }

    // 5. Analytics
    const trackEvent = (platform, eventName, contentName) => {
        if (typeof fbq === 'function') fbq('track', eventName, { content_name: contentName });
        if (typeof gtag === 'function') gtag('event', 'conversion', { 'send_to': 'G-M8GBYMDTLG', 'event_category': 'App Download', 'event_label': contentName });
        console.log(`[Analytics] Tracked ${platform}: ${eventName} - ${contentName}`);
    };

    document.querySelectorAll(TRACKING_CONFIG.huawei.selector).forEach(btn => btn.addEventListener('click', () => trackEvent('huawei', 'CompleteRegistration', TRACKING_CONFIG.huawei.name)));
    document.querySelectorAll(TRACKING_CONFIG.xiaomi.selector).forEach(btn => btn.addEventListener('click', () => trackEvent('xiaomi', 'CompleteRegistration', TRACKING_CONFIG.xiaomi.name)));
    const tfBtn = document.getElementById(TRACKING_CONFIG.testflight_dl.id);
    if (tfBtn) tfBtn.addEventListener('click', () => trackEvent('ios_step1', TRACKING_CONFIG.testflight_dl.event, TRACKING_CONFIG.testflight_dl.name));
    const instBtn = document.getElementById(TRACKING_CONFIG.app_install.id);
    if (instBtn) instBtn.addEventListener('click', () => trackEvent('ios_step2', TRACKING_CONFIG.app_install.event, TRACKING_CONFIG.app_install.name));

    // 6. Stats Animation
    const statsSection = document.querySelector('.platform-stats');
    const numbers = document.querySelectorAll('.stat-number');
    let statsStarted = false;

    if (statsSection && numbers.length > 0) {
        const statsObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !statsStarted) {
                    statsStarted = true;
                    numbers.forEach(num => startCount(num));
                }
            });
        }, { threshold: 0.5 });
        statsObserver.observe(statsSection);
    }

    // 7. Direct APK Download Message
    document.querySelectorAll('.btn-apk').forEach(btn => {
        btn.addEventListener('click', () => {
            const currentLang = document.documentElement.getAttribute('lang') || 'ar';
            const msg = translations[currentLang].apk_download_msg;
            alert(msg);
            // Optional: Track Event
            if (typeof trackEvent === 'function') trackEvent('apk', 'Download', 'Direct APK');
        });
    });
});